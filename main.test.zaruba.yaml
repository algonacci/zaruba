configs:
  mainTest:
    beforeStart:
      set -e
      ZARUBA_HOME="$(realpath ".")"


tasks:

  testCore:
    icon: 游눌
    location: ./
    extend: core.runShellScript
    dependencies:
    - clearLog
    configRef: mainTest
    config:
      start: |
        ZARUBA_HOME=""
        mkdir -p ./coverage
        rm -f ./test_resource/alchemy/alembic.txt
        rm -f ./test-resource/log.zaruba.csv
        go test -v ./... --race -coverprofile=./coverage/profile.out -covermode=atomic
        go tool cover -html=./coverage/profile.out -o ./coverage/coverage.html
  

  preparePlayground:
    icon: 游댣
    location: ./
    extend: core.runShellScript
    dependencies:
    - clearLog
    config:
      start: |
        if [ -d playground ]
        then
          chmod 777 -R playground
        fi
        rm -Rf playground
        mkdir -p playground
  

  testSetupPyenv:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupPyenv setup.injectBootstrap=false


  testSetupNvm:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupNvm setup.injectBootstrap=false


  testSetupSdkman:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupSdkman setup.injectBootstrap=false


  testSetupSpark:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupSpark setup.injectBootstrap=false


  testSetupKubeClient:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupKubeClient setup.injectBootstrap=false


  testThanks:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    configRef: mainTest
    config:
      start: ./zaruba thanks


  testSorry:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    configRef: mainTest
    config:
      start: ./zaruba sorry
  

  testShowVersion:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    configRef: mainTest
    config:
      start: ./zaruba please showVersion setup.injectBootstrap=false
  

  testPythonUtil:
    icon: 游눌
    location: ./scripts/util/python
    dependencies:
    - clearLog
    - build
    extend: core.runCoreScript
    config:
      start: pipenv run pytest -v --cov="$(pwd)" --cov-report html  


  testCommonTask:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    - testThanks
    - testSorry
    - testShowVersion
    - testSetupPyenv
    - testSetupNvm
    - testSetupSdkman
    - testSetupSpark
    - testSetupKubeClient
  

  test:
    icon: 游눌
    dependencies:
    - clearLog
    - testCore
    - testCommonTask
    - testPlayground
    - testPushImage
    - testHelmApply
    - testHelmDestroy
    - stopContainerRegistry
    - testPythonUtil