configs:
  mainTest:
    beforeStart:
      set -e
      ZARUBA_HOME="$(realpath ".")"


tasks:

  testCore:
    icon: 游눌
    location: ./
    extend: core.runShellScript
    dependencies:
    - clearLog
    configRef: mainTest
    config:
      start: |
        ZARUBA_HOME=""
        mkdir -p ./coverage
        rm -f ./test-resources/log.zaruba.csv
        go test -v ./... --race -coverprofile=./coverage/profile.out -covermode=atomic
        go tool cover -html=./coverage/profile.out -o ./coverage/coverage.html
  

  preparePlayground:
    icon: 游댣
    location: ./
    extend: core.runShellScript
    dependencies:
    - clearLog
    config:
      start: |
        if [ -d playground ]
        then
          chmod 777 -R playground
        fi
        rm -Rf playground
        mkdir -p playground
  

  testSetupPyenv:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupPyenv 


  testSetupNvm:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupNvm 


  testSetupSdkman:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupSdkman 


  testSetupSpark:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupSpark 


  testSetupKubeClient:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    timeout: 1h
    configRef: mainTest
    config:
      start: ./zaruba please setupKubeClient 


  testShowVersion:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    extend: core.runShellScript
    configRef: mainTest
    config:
      start: ./zaruba please showVersion 


  testCoreTask:
    icon: 游눌
    location: ./
    dependencies:
    - clearLog
    - build
    - testShowVersion
    - testSetupPyenv
    - testSetupNvm
    - testSetupSdkman
    - testSetupSpark
    - testSetupKubeClient


  testPythonUtil:
    icon: 游눌
    location: ./scripts/python
    dependencies:
    - clearLog
    - build
    - testCoreTask
    extend: core.runShellScript
    config:
      start: |
        pipenv install --dev
        pipenv run pytest -v --cov="$(pwd)" --cov-report html  
  

  test:
    icon: 游눌
    dependencies:
    - clearLog
    - testCore
    - testCoreTask
    - testPlayground
    - testPushImage
    - testHelmInstall
    - testHelmUninstall
    - stopContainerRegistry
    - testPythonUtil