tasks:

  core.checkIsValidProject:
    icon: üîç
    private: true
    extend: core.runShellScript
    config:
      script: |
        echo "Current directory should be a valid zaruba project"
        if [ ! -e main.zaruba.yaml ]
        then
          echo "$(pwd) is not a zaruba project" 1>&2 
          echo "The task has to be executed in a zaruba project directory" 1>&2 
          echo "You might want to 'initProject' first" 1>&2 
          exit 1
        fi
        echo "Current directory is a valid zaruba project"

 
  core.checkIsNotProject:
    icon: üîç
    private: true
    extend: core.runShellScript
    config:
      script: |
        echo "Current directory should not be a zaruba project"
        if [ -e main.zaruba.yaml ]
        then
          echo "$(pwd) is a zaruba project" 1>&2
          echo "The task cannot be executed in a zaruba project directory" 1>&2 
          exit 1
        fi
        echo "Current directory is not a zaruba project"

  
  initProject:
    icon: üöß
    description: Init a zaruba project in your working directory.
    extend: core.runShellScript
    dependencies:
      - core.checkIsNotProject
    config:
      script: | 
        git init
        cp "{{ .BasePath }}/project-template/default.kwargs.yaml" ./default.kwargs.yaml
        cp "{{ .BasePath }}/project-template/main.zaruba.yaml" ./main.zaruba.yaml
        echo "Project created"

  
  addDocker:
    icon: üê≥
    description: |
      Create docker task
      You need to specify `image`, `task`, and `container`. For example:
      ```sh
      zaruba please addDocker  <image=nginx> [container=myNginx] [task=runMyNginx]
    extend: core.runShellScript
    dependencies:
      - core.checkIsValidProject
      - core.setupPythonUtil
    config:
      script: |
        set -e
        BASEPATH="{{ .BasePath }}"
        SH_UTIL="${BASEPATH}/util/sh"
        PYTHON_UTIL="${BASEPATH}/util/python"
        export PIPENV_PIPFILE="${PYTHON_UTIL}/Pipfile"
        IMAGE="{{ if .Kwargs.image }}{{ .Kwargs.image }}{{ end }}"
        CONTAINER="{{ if .Kwargs.container }}{{ .Kwargs.container }}{{ end }}"
        TASK="{{ if .Kwargs.task }}{{ .Kwargs.task }}{{ end }}"
        pipenv run python "${PYTHON_UTIL}/create_docker_task.py" "${IMAGE}" "${CONTAINER}" "${TASK}"

 
  updateLinks:
    icon: üîó
    description: |
      Organize your shared library
      You must specify links `default.kwargs.yaml`:
      ```yaml
      link::<destination>: <source>
      ```
    extend: core.runShellScript
    dependencies:
      - core.checkIsValidProject
    config:
      script: |
        {{ $this := . -}}
        {{ $workPath := .WorkPath }}
        {{ $destinations := .Kwargs.GetSubKeys "link" -}}
        {{ $kwargs := .Kwargs -}}
        BASEPATH="{{ .BasePath }}"
        SH_UTIL="${BASEPATH}/util/sh"
        sh "${SH_UTIL}/git_save.sh" "Save works before organize"
        {{ range $index, $destination := $destinations -}}
          {{ $source := $kwargs.GetValue "link" $destination -}}
          {{ $absSource := $this.GetAbsPath $workPath $source -}}
          {{ $absDestination := $this.GetAbsPath $workPath $destination -}}
          rm -Rf "{{ $absDestination }}"
          cp -r "{{ $absSource }}" "{{ $absDestination }}"
          chmod 555 "{{ $absDestination }}"
        {{ end -}}
        echo "Links updated"
