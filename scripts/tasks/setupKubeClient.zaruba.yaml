tasks:
  
  setupKubeClient:
    icon: üî®
    description: Install kubectl, helm, and helmfile
    extend: core.runCoreScript
    timeout: 1h
    inputs:
      - setupHomeDir
      - setupHelmfileVersion
    config:
      beforeStart: |
        {{ $d := .Decoration -}}
        echo "This command will install Kubectl and helm in your home directory. Root privilege is not required"
        echo "If this command doesn't run successfully, please open an issue on https://github.com/state-alcemists/zaruba."
        echo "Please also specify your OS version."
      start: |
        {{ $d := .Decoration -}}
        {{ if .GetValue "setupHomeDir" }}HOME="{{ .GetValue "setupHomeDir" }}"{{ end }}
        if [ "$(is_command_exist kubectl version)" = 1 ]
        then
          echo "üëè {{ $d.Bold }}{{ $d.Yellow }}Kubectl was already installed{{ $d.Normal }}"
        else
          rm -Rf "${HOME}/.local/bin/kubectl"
          echo "üé° {{ $d.Bold }}{{ $d.Yellow }}Install Kubectl{{ $d.Normal }}"
          wget "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod 755 kubectl
          mkdir -p "${HOME}/.local/bin"
          mv kubectl "${HOME}/.local/bin"
        fi
        if [ "$(is_command_exist helm version)" = 1 ]
        then
          echo "üëè {{ $d.Bold }}{{ $d.Yellow }}Helm was already installed{{ $d.Normal }}"
        else
          echo "üé° {{ $d.Bold }}{{ $d.Yellow }}Install helm{{ $d.Normal }}"
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          export HELM_INSTALL_DIR="${HOME}/.local/bin"
          ./get_helm.sh --no-sudo
          rm ./get_helm.sh
        fi
        if [ "$(is_command_exist helmfile --version)" = 1 ]
        then
          echo "üëè {{ $d.Bold }}{{ $d.Yellow }}Helmfile was already installed{{ $d.Normal }}"
        else
          rm -Rf "${HOME}/.local/bin/helmfile"
          echo "üé° {{ $d.Bold }}{{ $d.Yellow }}Install helmfile{{ $d.Normal }}"
          wget https://github.com/roboll/helmfile/releases/download/{{ .GetValue "setupHelmfileVersion" }}/helmfile_linux_amd64
          chmod 755 ./helmfile_linux_amd64
          mkdir -p "${HOME}/.local/bin"
          mv ./helmfile_linux_amd64 "${HOME}/.local/bin/helmfile"
        fi