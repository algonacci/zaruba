tasks:

  addSubrepo:
    icon: ðŸ¥‚
    description: |
      Add subrepository.
      TIPS: To init added subrepositories, you should perform `zaruba please initSubrepos`
    extend: core.runCoreScript
    dependencies:
      - core.isProject
      - core.setupPyUtil
    inputs:
      - subrepoUrl
      - subrepoPrefix
      - subrepoName
    config:
      subrepoUrl: '{{ .GetValue "subrepoUrl" }}'
      subrepoPrefix: '{{ .GetValue "subrepoPrefix" }}'
      subrepoName: '{{ .GetValue "subrepoName" }}'
      start: |
        set -e
        {{ $d := .Decoration -}}
        URL="{{ .GetValue "subrepoUrl" }}"
        should_not_be_empty "${URL}" "{{ $d.Bold }}{{ $d.Red }}subrepoUrl is not defined{{ $d.Normal }}"
        {{ if .GetValue "subrepoPrefix" }}
          PREFIX="{{ .GetValue "subrepoPrefix" }}"
        {{ else }}
          {{ $urlSegment := .Split (.GetConfig "subrepoUrl") "/" -}}
          {{ $urlSegmentLastIndex := .Subtract (len $urlSegment) 1 -}}
          {{ $urlLastSegment := index $urlSegment $urlSegmentLastIndex -}}
          {{ $prefix := index (.Split $urlLastSegment ".") 0 -}}
          PREFIX="{{ $prefix }}"
        {{ end }}
        NAME="{{ if .GetValue "subrepoName" }}{{ .GetValue "subrepoName" }}{{ else }}${PREFIX}{{ end }}"
        {{ .Zaruba }} setProjectValue "{{ .GetWorkPath "default.values.yaml" }}" "subrepo::${NAME}::prefix" "${PREFIX}"
        {{ .Zaruba }} setProjectValue "{{ .GetWorkPath "default.values.yaml" }}" "subrepo::${NAME}::url" "${URL}"
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Subrepo ${NAME} has been added{{ $d.Normal }}"

