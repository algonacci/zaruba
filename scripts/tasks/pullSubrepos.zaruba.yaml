tasks:

  pullSubrepos:
    icon: ðŸ”½
    description: |
      Pull subrepositories.
      ARGUMENTS:
        subrepo::<name>::prefix   : Prefix (directory name) of the subrepo
        subrepo::<name>::url      : Remote url of the subrepo
    extend: core.runCoreScript
    dependencies:
      - initSubrepos
    config:
      start: |
        set -e
        {{ $d := .Decoration -}}
        {{ $names := .GetSubValueKeys "subrepo" -}}
        {{ $this := . -}}
        ORIGINS=$("{{ .ZarubaBin }}" split "$(git remote)")
        BRANCH="{{ if .GetValue "defaultBranch" }}{{ .GetValue "defaultBranch" }}{{ else }}main{{ end }}"
        {{ range $index, $name := $names -}}
          PREFIX="{{ $this.GetValue "subrepo" $name "prefix" }}"
          URL="{{ $this.GetValue "subrepo" $name "url" }}"
          NAME="{{ $name }}"
          ORIGIN_EXISTS=$("{{ $this.ZarubaBin }}" isInList "${ORIGINS}" "${NAME}")
          if [ $ORIGIN_EXISTS = 1 ]
          then
            git_save "Save works before pull"
            git subtree pull --prefix="${PREFIX}" "${NAME}" "${BRANCH}"
          fi
        {{ end -}}
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Subrepos pulled{{ $d.Normal }}"

