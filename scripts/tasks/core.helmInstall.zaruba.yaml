tasks:
  core.helmInstall:
    extend: core.runCoreScript
    private: true
    dependencies:
      - core.helmRepoUpdate
    config:
      chart: ''
      valueFile: ''
      valueTemplateFile: ''
      releaseName: ''
      kubeContext: '{{ .GetValue "kubeContext" }}'
      start: |
        mkdir -p "$(dirname "{{ .GetConfig "valueFile" }}")"
        {{ $fileContent := .ParseFile (.GetConfig "valueTemplateFile") -}}
        {{ $err := .WriteFile (.GetConfig "valueFile") $fileContent -}}
        {{ if ne $err nil -}}
        echo '{{ $err }}'
        exit 1
        {{ end -}}
        if [ "$(kubectl config current-context)" != "{{ .GetConfig "kubeContext" }}" ]
        then
          kubectl config set-context "{{ .GetConfig "kubeContext" }}"
        fi
        if [ "$(is_command_error helm status "{{ .GetConfig "releaseName" }}")" ]
        then
          helm install "{{ .GetConfig "releaseName" }}" "{{ .GetConfig "chart" }}" -f "{{ .GetConfig "valueFile" }}"
        else
          helm upgrade "{{ .GetConfig "releaseName" }}" "{{ .GetConfig "chart" }}" -f "{{ .GetConfig "valueFile" }}"
        fi
