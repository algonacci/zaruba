tasks:

  initSubrepos:
    icon: ðŸ“¦
    description: |
      Init subrepositories.
      ARGUMENTS:
        subrepo::<name>::prefix   : Prefix (directory name) of the subrepo
        subrepo::<name>::url      : Remote url of the subrepo
        subrepo::<name>::name     : Origin name of the subrepo
      TIPS:
        It is recommended to put `subrepo` arguments in `default.values.yaml`.
        In order to do that, you can invoke `zaruba please addSubrepo <subrepoUrl=remote-url>`
    extend: core.runCoreScript
    dependencies:
      - core.isProject
      - core.isValidSubrepos
    config:
      start: |
        set -e
        {{ $d := .Decoration -}}
        {{ $names := .GetSubValueKeys "subrepo" -}}
        {{ $this := . -}}
        BRANCH="{{ if .GetValue "defaultBranch" }}{{ .GetValue "defaultBranch" }}{{ else }}main{{ end }}"
        ORIGINS=$({{ .Zaruba }} split "$(git remote)")
        {{ range $index, $name := $names -}}
          PREFIX="{{ $this.GetValue "subrepo" $name "prefix" }}"
          URL="{{ $this.GetValue "subrepo" $name "url" }}"
          NAME="{{ $name }}"
          ORIGIN_EXISTS=$({{ $this.Zaruba }} isInList "${ORIGINS}" "${NAME}")
          if [ "$ORIGIN_EXISTS" = "1" ]
          then
            git remote set-url "${NAME}" "${URL}"
          elif [ "$ORIGIN_EXISTS" = "0" ]
          then
            echo "$NAME origin is not exist"
            git_save "Save works before pulling from ${URL}"
            PREFIX_EXISTS=0
            if [ -d "$PREFIX" ]
            then
              PREFIX_EXISTS=1
              mv "${PREFIX}" "${PREFIX}.bak"
              git_save "Temporarily move ${PREFIX}"
            fi
            git_init_subrepo "${NAME}" "${PREFIX}" "${URL}" "${BRANCH}"
            if [ "$PREFIX_EXISTS" = "1" ]
            then
              rm -Rf "${PREFIX}"
              mv "${PREFIX}.bak" "${PREFIX}"
              git_save "Restore ${PREFIX}"
            fi
          fi
        {{ end -}}
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Subrepos Initialized{{ $d.Normal }}"

