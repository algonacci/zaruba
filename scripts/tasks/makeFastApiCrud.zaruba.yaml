tasks: 

  makeFastApiCrud:
    icon: âš¡
    description: Make FastAPI crud
    inputs:
      - generatorFastApiServiceName
      - generatorFastApiCreateTask
      - generatorFastApiModuleName
      - generatorFastApiCrudEntity
      - generatorFastApiCrudFields
    extend: core.runCoreScript
    dependencies:
      - core.showAdv
    configRef: generatorFastApi
    config:
      templateLocation: '{{ .GetEnv "ZARUBA_HOME" }}/scripts/templates/fastApiCrud'
      entityName: '{{ .GetValue "generatorFastApiCrudEntity" }}'
      fieldNames: '{{ .GetValue "generatorFastApiCrudFields" }}'
      start: |
        {{- $d := .Decoration -}}
        {{ .GetConfig "createModuleScript" }}
        TEMPLATE_LOCATION={{ .EscapeShellArg (.GetConfig "templateLocation") }}
        SERVICE_NAME={{ .EscapeShellArg (.GetConfig "serviceName") }}
        CAMEL_SERVICE_NAME=$({{ .Zaruba }} strToCamel "${SERVICE_NAME}")
        PASCAL_SERVICE_NAME=$({{ .Zaruba }} strToPascal "${SERVICE_NAME}")
        MODULE_NAME={{ .EscapeShellArg (.GetConfig "moduleName") }}
        CAMEL_MODULE_NAME=$({{ .Zaruba }} strToCamel "${MODULE_NAME}")
        PASCAL_MODULE_NAME=$({{ .Zaruba }} strToPascal "${MODULE_NAME}")
        SNAKE_MODULE_NAME=$({{ .Zaruba }} strToSnake "${MODULE_NAME}")
        ENTITY_NAME={{ .EscapeShellArg (.GetConfig "entityName") }}
        CAMEL_ENTITY_NAME=$({{ .Zaruba }} strToCamel "${ENTITY_NAME}")
        PASCAL_ENTITY_NAME=$({{ .Zaruba }} strToPascal "${ENTITY_NAME}")
        SNAKE_ENTITY_NAME=$({{ .Zaruba }} strToSnake "${ENTITY_NAME}")
        FIELD_NAMES={{ .EscapeShellArg (.GetConfig "fieldNames") }}

        REPLACEMENT_MAP=$({{ .Zaruba }} mapSet "{}" \
          "zarubaServiceName" "${CAMEL_SERVICE_NAME}" \
          "ZarubaServiceName" "${PASCAL_SERVICE_NAME}" \
          "zarubaModuleName" "${CAMEL_MODULE_NAME}" \
          "ZarubaModuleName" "${PASCAL_MODULE_NAME}" \
          "zaruba_module_name" "${SNAKE_MODULE_NAME}" \
          "zarubaEntityName" "${CAMEL_ENTITY_NAME}" \
          "ZarubaEntityName" "${PASCAL_ENTITY_NAME}" \
          "zaruba_entity_name" "${SNAKE_ENTITY_NAME}" \
        )
        {{ .Zaruba }} generate "${TEMPLATE_LOCATION}/zarubaServiceName" "${CAMEL_SERVICE_NAME}" "${REPLACEMENT_MAP}"

        # init repo on main.py
        INIT_REPO_PARTIAL="$(cat "${TEMPLATE_LOCATION}/partials/init_repo.py")"
        INIT_REPO_PARTIAL="$({{ .Zaruba }} strReplace "${HANDLE_EVENT_PARTIAL}" "${REPLACEMENT_MAP}" )"
        MAIN_LINES=$({{ .Zaruba }} readLines "${CAMEL_SERVICE_NAME}/main.py" )


        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Fast API module created: ${SERVICE_NAME}/${MODULE_NAME}{{ $d.Normal }}"
        echo "You probably need to check the following files:"
        echo "- ${SERVICE_NAME}/main.py"
        echo "- ${SERVICE_NAME}/${MODULE_NAME}/controller.py"
        echo "- ${SERVICE_NAME}/${MODULE_NAME}/handle<Entity>Event.py"
        echo "- ${SERVICE_NAME}/${MODULE_NAME}/handle<Entity>Route.py"
        echo "- ${SERVICE_NAME}/repos/<entity>.py"
        echo "- ${SERVICE_NAME}/repos/db<Entity>.py"
        echo "- ${SERVICE_NAME}/schemas/<entity>.py"