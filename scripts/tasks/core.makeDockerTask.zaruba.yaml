tasks:

  core.makeDockerTask:
    extend: core.runCoreScript
    private: true
    dependencies:
      - core.showAdv
      - core.isProject
    config:
      templateLocation: '{{ .GetEnv "ZARUBA_HOME" }}/templates/task/docker/default'
      imageName: '{{ .GetValue "dockerImageName" }}'
      containerName: '{{ .GetValue "dockerContainerName" }}'
      serviceName: '{{ .GetValue "serviceName" }}'
      servicePorts: '{{ .GetValue "servicePorts" }}'
      serviceEnvs: '{{ .GetValue "serviceEnvs" }}'
      dependencies: '{{ .GetValue "taskDependencies" }}'
      registerRunner: true
      replacementMap: '{}'
      generatorScriptLocation: "${ZARUBA_HOME}/bash/generateDockerTask.sh"
      generatorFunctionName: "generateDockerTask"
      generatorFunctionArgs: |
        "${TEMPLATE_LOCATION}" \
        "${IMAGE_NAME}" \
        "${CONTAINER_NAME}" \
        "${SERVICE_NAME}" \
        "${SERVICE_PORTS}" \
        "${SERVICE_ENVS}" \
        "${DEPENDENCIES}" \
        "${REPLACEMENT_MAP}" \
        "{{ if .IsFalse (.GetConfig "registerRunner") }}0{{ else }}1{{ end }}"
      _setup: |
        set -e
        {{ .Util.Str.Trim (.GetConfig "includeUtilScript") "\n" }}
        . "${ZARUBA_HOME}/bash/generatorUtil.sh"
        TEMPLATE_LOCATION={{ .Util.Str.EscapeShellArg (.GetConfig "templateLocation") }}
        IMAGE_NAME={{ .Util.Str.EscapeShellArg (.GetConfig "imageName") }}
        CONTAINER_NAME={{ .Util.Str.EscapeShellArg (.GetConfig "containerName") }}
        SERVICE_NAME={{ .Util.Str.EscapeShellArg (.GetConfig "serviceName") }}
        SERVICE_PORTS={{ .Util.Str.EscapeShellArg (.GetConfig "servicePorts") }}
        SERVICE_ENVS={{ .Util.Str.EscapeShellArg (.GetConfig "serviceEnvs") }}
        DEPENDENCIES={{ .Util.Str.EscapeShellArg (.GetConfig "dependencies") }}
        REPLACEMENT_MAP={{ .Util.Str.EscapeShellArg (.GetConfig "replacementMap") }}
        # ensure CONTAINER_NAME is not empty
        CONTAINER_NAME="$(getDockerContainerName "${CONTAINER_NAME}" ${IMAGE_NAME} ${_TEMPLATE_LOCATION})"
        # ensure SERVICE_NAME is not empty
        SERVICE_NAME="$(getDockerServiceName "${SERVICE_NAME}" "${CONTAINER_NAME}")"
      _start: |
        __PWD="$(pwd)"
        . "{{ .GetConfig "generatorScriptLocation" }}"
        {{ .GetConfig "generatorFunctionName" }} \
        {{ .GetConfig "generatorFunctionArgs" }}
        cd "${__PWD}"
      _finish: |
        {{- $d := .Decoration -}}
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Docker task for ${SERVICE_NAME} has been created{{ $d.Normal }}"
      start: ''

