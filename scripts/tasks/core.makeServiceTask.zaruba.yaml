tasks:

  core.makeServiceTask:
    extend: core.runCoreScript
    private: true
    dependencies:
      - core.showAdv
      - core.isProject
    config:
      allowInexistServiceLocation: false
      templateLocation: '{{ .GetEnv "ZARUBA_HOME" }}/templates/task/service/default'
      serviceLocation: '{{ .GetValue "serviceLocation" }}'
      serviceName: '{{ .GetValue "serviceName" }}'
      imageName: '{{ .GetValue "serviceImageName" }}'
      containerName: '{{ .GetValue "serviceContainerName" }}'
      serviceStartCommand: '{{ .GetValue "startCommand" }}'
      serviceRunnerVersion: ''
      servicePorts: '{{ .GetValue "servicePorts" }}'
      serviceEnvs: '{{ .GetValue "serviceEnvs" }}'
      dependencies: '{{ .GetValue "taskDependencies" }}'
      registerRunner: true
      replacementMap: '{}'
      generatorScriptLocation: "${ZARUBA_HOME}/bash/generateServiceTask.sh"
      generatorFunctionName: "generateServiceTask"
      _setup: |
        TEMPLATE_LOCATION={{ .EscapeShellArg (.GetConfig "templateLocation") }}
        SERVICE_LOCATION={{ .EscapeShellArg (.GetConfig "serviceLocation") }}
        SERVICE_NAME={{ .EscapeShellArg (.GetConfig "serviceName") }}
        IMAGE_NAME={{ .EscapeShellArg (.GetConfig "imageName") }}
        CONTAINER_NAME={{ .EscapeShellArg (.GetConfig "containerName") }}
        SERVICE_START_COMMAND={{ .EscapeShellArg (.GetConfig "serviceStartCommand") }}
        SERVICE_RUNNER_VERSION={{ .EscapeShellArg (.GetConfig "serviceRunnerVersion") }}
        SERVICE_PORTS={{ .EscapeShellArg (.GetConfig "servicePorts") }}
        SERVICE_ENVS={{ .EscapeShellArg (.GetConfig "serviceEnvs") }}
        DEPENDENCIES={{ .EscapeShellArg (.GetConfig "dependencies") }}
        REPLACEMENT_MAP={{ .EscapeShellArg (.GetConfig "replacementMap") }}
      _start: |
        {{- $d := .Decoration -}}
        {{ if .IsTrue (.GetConfig "allowInexistServiceLocation") -}}
        mkdir -p "{{ .GetConfig "serviceLocation" }}"
        {{ end -}}
        . "{{ .GetConfig "generatorScriptLocation" }}"
        {{ .GetConfig "generatorFunctionName" }} \
          "${TEMPLATE_LOCATION}" \
          "${SERVICE_LOCATION}" \
          "${SERVICE_NAME}" \
          "${IMAGE_NAME}" \
          "${CONTAINER_NAME}" \
          "${SERVICE_START_COMMAND}" \
          "${SERVICE_RUNENR_VERSION}" \
          "${SERVICE_PORTS}" \
          "${SERVICE_ENVS}" \
          "${DEPENDENCIES}" \
          "${REPLACEMENT_MAP}" \
          "{{ if .IsFalse (.GetConfig "registerRunner") }}0{{ else }}1{{ end }}"
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "{{ $d.Bold }}{{ $d.Yellow }}Service task created{{ $d.Normal }}"
      start: ''
