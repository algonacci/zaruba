tasks:

  core.monitorPorts:
    icon: ðŸ”Ž
    description: |
      Throw error when any port is inactive
      Common config:
        ports : Port to be checked to confirm service readiness, separated by new line.
    private: true
    extend: core.startService
    config:
      ports: 8080
      interval: 1
      _setup.ports: |
        PORTS=""
        {{ range $index, $hostPort := .Split (.Trim (.GetConfig "ports" "\n ") "\n") -}}
          {{ if ne $port "" -}}
            PORTS="${PORTS} {{ $port }}"
          {{ end -}}
        {{ end -}}
      _setup: '{{ .GetConfig "_setup.ports" }}'
      _start.checkPorts: |
        {{ $d := .Decoration -}}
        for PORT in ${PORTS}
        do
          if nc -z "localhost" "${PORT}"
          then
            continue
          fi
          echo "ðŸ”Ž {{ $d.Bold }}{{ $d.Red }}Port '${PORT}' is not listening{{ $d.Normal }}"
          exit 1
        done
      _start: |
        {{ $d := .Decoration -}}
        while true
        do
          {{ .GetConfig "_start.checkPorts" }}
          sleep {{ .GetConfig "interval" }}
        done
      _check: |
        {{ $d := .Decoration -}}
        echo "ðŸ”Ž {{ $d.Bold }}{{ $d.Yellow }}Port monitoring started for: ${PORTS}{{ $d.Normal }}"
 