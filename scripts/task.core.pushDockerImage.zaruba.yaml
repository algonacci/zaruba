tasks:

  core.pushDockerImage:
    icon: üê≥
    private: true
    description: |
      Push docker image.
      Common config:
        dockerEnv : Docker environment key (default: '{{ .GetValue "dockerEnv" }}')
        imageName : Image name
    extend: core.runCoreScript
    dependencies:
    - core.setupPyUtil
    - updateProjectLinks
    configRef: coreDocker
    config:
      imagePrefixTrailingSlash: true
      start: |
        {{ $d := .Decoration -}}
        {{ .Trim (.GetConfig "initDockerImagePrefixScript") "\n" }}
        IMAGE_NAME="{{ if .GetConfig "imageName" }}{{ .GetConfig "imageName" }}{{ else }}$({{ .Zaruba }} getServiceName "$(pwd)"){{ end }}"
        COMMIT="$(get_latest_git_commit)"
        if [ ! -z "${COMMIT}" ]
        then
          SHORT_COMMIT="$(echo "${COMMIT}" | cut -c1-12)"
          TAG="$(get_latest_git_tag)"
          if [ ! -z "${TAG}" ]
          then
            TAG_COMMIT="$(get_latest_git_tag_commit)"
            if [ "${TAG_COMMIT}" = "${COMMIT}" ]
            then
              docker push "${DOCKER_IMAGE_PREFIX}${IMAGE_NAME}:${TAG}"
            fi
            docker push "${DOCKER_IMAGE_PREFIX}${IMAGE_NAME}:${TAG}-${SHORT_COMMIT}"
          fi
          docker push "${DOCKER_IMAGE_PREFIX}${IMAGE_NAME}:${SHORT_COMMIT}"
        fi
        docker push "${DOCKER_IMAGE_PREFIX}${IMAGE_NAME}:latest"
        echo üéâüéâüéâ
        echo "{{ $d.Bold }}{{ $d.Yellow }}Docker image ${IMAGE_NAME} pushed{{ $d.Normal }}"
 