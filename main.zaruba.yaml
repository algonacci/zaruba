includes:
  - "./main.test.zaruba.yaml"
  - "./main.testGenerator.zaruba.yaml"
  - "./main.testHelm.zaruba.yaml"

configs:

  zarubaDocker:
    imagePrefix: '{{ .GetValue "defaultImagePrefix" }}'
    imageTag: '{{ .GetValue "defaultImageTag" }}'


tasks:


  build:
    icon: 🚧
    location: ./
    extend: core.runShellScript
    dependencies:
      - clearLog
    config:
      start: |
        set -e
        rm -f zaruba
        go build


  serveCoverage:
    icon: 🥗
    location: ./coverage
    extend: serveHttp
    dependencies:
      - clearLog
      - testCore
  

  buildZarubaImage:
    icon: 🐳
    extend: core.buildDockerImage
    dependencies:
      - clearLog
      - buildDevboxImage
    configRef: zarubaDocker
    location: ./
    timeout: 1h


  buildDevboxImage:
    icon: 🐳
    extend: core.buildDockerImage
    dependencies:
      - clearLog
    configRef: zarubaDocker
    location: ./devbox
    timeout: 1h


  buildDocker:
    icon: 🚧
    dependencies:
      - clearLog
      - buildZarubaImage
      - buildDevboxImage


  runAsContainer:
    icon: 🐳
    location: ./
    extend: core.startDockerContainer
    dependencies:
      - clearLog
      - buildZarubaImage
    config:
      ports: |
        2810
      localhost: host.docker.internal
      imageName: local/zaruba:latest
      containerName: zaruba
      rebuild: true


  pushZarubaImage:
    icon: 🐳
    extend: core.pushDockerImage
    dependencies:
      - clearLog
      - buildZarubaImage
    configRef: zarubaDocker
    location: ./
    timeout: 1h


  pushDevboxImage:
    icon: 🐳
    extend: core.pushDockerImage
    dependencies:
      - clearLog
      - buildDevboxImage
    configRef: zarubaDocker
    location: ./devbox
    timeout: 1h


  pushDocker:
    icon: 🔼
    dependencies:
      - clearLog
      - pushZarubaImage
      - pushDevboxImage


  pushRepo:
    icon: 🔼
    location: ./
    extend: core.runShellScript
    dependencies:
      - clearLog
    config:
      start: |
        git add . -A
        git commit -m "Save changes before pushing"
        git push -u origin HEAD


  push:
    icon: 🔼
    dependencies:
      - clearLog
      - pushDocker
      - pushRepo


  install:
    icon: 🔨
    location: ./
    extend: core.runShellScript
    dependencies:
      - clearLog
    config:
      start: ./install.sh


  makeTaskDocs:
    location: ./
    extend: core.runShellScript
    dependencies:
      - build
    config:
      start: |
        set -e
        rm -Rf ./docs/tasks
        mkdir -p ./docs/tasks
        echo "This directory is autogenerated do not modify" > ./docs/tasks/README.md
        REPLACEMENT_MAP="$(./zaruba setMapElement "{}" "${ZARUBA_HOME}" '${ZARUBA_HOME}')"
        LINES="$(./zaruba readLines "./scripts/core.zaruba.yaml")"
        LINE_INDEX=0
        MAX_LINE_INDEX=$(($(./zaruba getListLength "$LINES")-1))
        for LINE_INDEX in $(seq 0 "${MAX_LINE_INDEX}")
        do
          LINE="$(./zaruba getFromList "${LINES}" "${LINE_INDEX}")"
          SUBMATCH="$(./zaruba strSubmatch "'""${LINE}""'" ".*\./tasks\/(.*)\.zaruba\.yaml.*")"
          if [ "$(./zaruba getListLength "${SUBMATCH}")" = 2 ]
          then
            TASK_NAME="$(./zaruba getFromList "${SUBMATCH}" 1)"
            echo ${TASK_NAME}
            TASK_EXPLANATION=$(./zaruba please "${TASK_NAME}" -x -n)
            TASK_EXPLANATION=$(./zaruba strReplace "${TASK_EXPLANATION}" "${REPLACEMENT_MAP}")
            TASK_EXPLANATION_LINES=$(./zaruba split "${TASK_EXPLANATION}")
            DOCS="[]"
            DOCS=$(./zaruba appendToList "[]" "# ${TASK_NAME}" "\`\`\`")
            DOCS=$(./zaruba mergeList "${DOCS}" "${TASK_EXPLANATION_LINES}")
            DOCS=$(./zaruba appendToList "${DOCS}" "\`\`\`")
            DOC_FILE="./docs/tasks/${TASK_NAME}.md"
            ./zaruba writeLines "${DOC_FILE}" "${DOCS}"
          fi
        done