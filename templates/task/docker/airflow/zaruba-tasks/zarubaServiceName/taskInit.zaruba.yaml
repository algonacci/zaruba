tasks:

  createZarubaServiceNameDb:
    extend: zarubaAirflowPostgreServiceExecSql
    dependencies:
      - zarubaAirflowPostgreTask
    config:
      queries: 'CREATE DATABASE {{ .GetConfig "dbName" }}'
    configRef: createZarubaServiceNameDb
    envRef: createZarubaServiceNameDb

  createZarubaServiceNameConfiguratorScript:
    extend: core.runShellScript
    location: ../../zarubaServiceName
    config:
      start: |
        {{ $err := .WriteFile (.GetRelativePath "../../zarubaServiceName/configurator.sh") (.ParseFile (.GetRelativePath "../../zarubaServiceName/configurator.gotmpl.sh")) }}
    configRefs:
      - zarubaServiceNameConfigurator
      - zarubaServiceNameContainer
    envRefs:
      - zarubaServiceNameConfigurator
      - zarubaServiceName

  configureZarubaServiceName:
    extend: core.runDockerContainer
    location: ../../zarubaServiceName
    dependencies:
      - zarubaAirflowRedisTask
      - zarubaAirflowPostgreTask
      - createZarubaServiceNameDb
      - createZarubaServiceNameConfiguratorScript
      - buildZarubaServiceNameImage
    timeout: 1h
    inputs:
      - zarubaServiceNameRunInLocal
    configRefs:
      - zarubaServiceNameConfigurator
      - zarubaServiceNameContainer
    envRefs:
      - zarubaServiceNameConfigurator
      - zarubaServiceName

  configureZarubaServiceNameWorker:
    extend: core.runInDockerContainer
    location: ../../zarubaServiceName
    dependencies:
      - runZarubaServiceNameWorker
    config:
      containerShell: bash
      commands: |
        {{ .ParseFile "worker.gotmpl.sh"}}
    configRef: zarubaServiceNameWorker
    envRef: zarubaServiceNameWorker
  

