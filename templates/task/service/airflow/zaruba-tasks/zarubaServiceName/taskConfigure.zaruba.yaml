tasks:

  createZarubaServiceNameDb:
    extend: zarubaPostgreServiceExecSql
    dependencies:
      - zarubaPostgreTask
    config:
      queries: 'CREATE DATABASE {{ .GetConfig "dbName" }}'
    configRef: createZarubaServiceNameDb
    envRef: createZarubaServiceNameDb

  createZarubaServiceNameInitScript:
    extend: core.runShellScript
    location: ../../zarubaServiceName
    config:
      start: |
        {{ $err := .WriteFile "configurator/init.sh" (.ParseFile "configurator/init.gotmpl.sh") }}
    configRefs:
      - zarubaServiceNameConfigurator
      - zarubaServiceNameContainer
    envRefs:
      - zarubaServiceNameConfigurator
      - zarubaServiceName

  initZarubaServiceName:
    extend: core.runDockerContainer
    location: ../../zarubaServiceName
    dependencies:
      - zarubaRedisTask
      - zarubaPostgreTask
      - createZarubaServiceNameDb
      - createZarubaServiceNameInitScript
      - buildZarubaServiceNameImage
    timeout: 1h
    inputs:
      - zarubaServiceNameRunInLocal
    configRefs:
      - zarubaServiceNameConfigurator
      - zarubaServiceNameContainer
    envRefs:
      - zarubaServiceNameConfigurator
      - zarubaServiceName

  configureZarubaServiceNameWorker:
    extend: core.runInDockerContainer
    location: ../../zarubaServiceName
    dependencies:
      - runZarubaServiceNameWorker
    config:
      containerShell: bash
      commands: |
        {{ .ParseFile "worker/init.gotmpl.sh"}}
    configRef: zarubaServiceNameWorker
    envRef: zarubaServiceNameWorker
  

