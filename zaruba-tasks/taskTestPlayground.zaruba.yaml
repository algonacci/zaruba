tasks:

  testMakePlayground:
    location: ../playground
    dependencies:
      - build
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please initProject 
        ../zaruba please setProjectValue variableName=defaultImagePrefix variableValue=localhost:9999 
        ../zaruba please addSubrepo subrepoUrl="https://github.com/state-alchemists/fibonacci-clock" subrepoPrefix="fibo" 
        ../zaruba please addSubrepo subrepoUrl="https://github.com/state-alchemists/fibonacci-clock" subrepoPrefix="other-fibo" 
        ../zaruba please initSubrepos 
        ../zaruba please pullSubrepos 
        #
        # service related
        #
        ../zaruba please makeStaticServiceTask generatorServiceLocation=fibo generatorServiceEnvs='{"HTTP_PORT": "3001"}'
        ../zaruba please makeMeltanoServiceTask generatorServiceLocation=testMeltano showAdvertisement=no  
        #
        # docker related
        #
        ../zaruba please makeRabbitmqDockerTask generatorDockerContainerName=testRabbitMq showAdvertisement=no 
        ../zaruba please makeMysqlDockerTask generatorDockerContainerName=testMySql showAdvertisement=no 
        ../zaruba please makeCassandraDockerTask generatorDockerContainerName=testCassandra showAdvertisement=no 
        ../zaruba please makeElasticsearchDockerTask generatorDockerContainerName=testElasticSearch showAdvertisement=no 
        ../zaruba please makeMongoDockerTask generatorDockerContainerName=testMongo showAdvertisement=no 
        ../zaruba please makeRedisDockerTask generatorDockerContainerName=testRedis showAdvertisement=no 
        ../zaruba please makePostgreDockerTask generatorDockerContainerName=testPostgre showAdvertisement=no 
        ../zaruba please makeAirflowDockerTask generatorDockerContainerName=testAirflow generatorRedisTask=runTestRedis generatorPostgreTask=runTestPostgre showAdvertisement=no 
        ../zaruba please makeTrinoDockerTask generatorDockerContainerName=testTrino showAdvertisement=no generatorServicePorts='["8081:8080"]'
        ../zaruba please makeNginxDockerTask generatorDockerContainerName=testNginx
        #
        # fastapi related
        #
        ../zaruba please makeFastApiService generatorFastApiServiceName=myService showAdvertisement=no  
        ../zaruba please makeFastApiServiceTask generatorServiceLocation=myService generatorServiceType=fastapi showAdvertisement=no 
        ../zaruba please makeFastApiModule generatorFastApiServiceName=myService generatorFastApiModuleName=myModule showAdvertisement=no 
        ../zaruba please makeFastApiRoute generatorFastApiServiceName=myService generatorFastApiModuleName=myModule generatorFastApiUrl=/hello showAdvertisement=no 
        ../zaruba please makeFastApiEventHandler generatorFastApiServiceName=myService generatorFastApiModuleName=myModule generatorFastApiEventName=myEvent showAdvertisement=no 
        ../zaruba please makeFastApiRpcHandler generatorFastApiServiceName=myService generatorFastApiModuleName=myModule generatorFastApiRpcName=myRpc showAdvertisement=no 
        ../zaruba please makeFastApiCrud generatorFastApiServiceName=myService generatorFastApiModuleName=myModule generatorFastApiCrudEntity=book generatorFastApiCrudFields='["title", "author" , "synopsis"]' showAdvertisement=no 


  testSyncEnv:
    location: ../playground
    dependencies:
      - testMakePlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        touch .env
        ../zaruba please syncEnv 


  testRun:
    location: ../playground
    dependencies:
      - testSyncEnv
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please removeContainer
        ../zaruba please run -t


  testRunContainer:
    location: ../playground
    dependencies:
      - testRun
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please stopContainer 
        ../zaruba please runContainer -t
        ../zaruba please removeContainer 


  testBuildImage:
    location: ../playground
    dependencies:
      - testRunContainer
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please buildImage


  testLogging:
    location: ../playground
    dependencies:
      - testBuildImage
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please showLog logKeyword=myService 


  pullContainerRegistry:
    icon: üê≥
    location: ../
    extend: core.pullDockerImage
    timeout: 1h
    configRef: containerRegistry


  runContainerRegistry:
    icon: üê≥
    location: ../
    extend: core.startDockerContainer
    dependencies:
      - pullContainerRegistry
    configRef: containerRegistry


  testPushImage:
    location: ../playground
    dependencies:
      - runContainerRegistry
      - testBuildImage
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please pushImage
  

  runPlayground:
    location: ../playground
    inputs:
      - runPlaygroundDelay
    dependencies:
      - testPushImage
    extend: core.startService
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please runContainer  -e "MY_SERVICE_SQLALCHEMY_DATABASE_URL=sqlite:///database.db"
      afterCheck: |
        sleep 1
        echo "Wait for {{ .GetValue "runPlaygroundDelay" }} s"
        sleep {{ .GetValue "runPlaygroundDelay" }}
      ports: |
        3000
        8080
        15672
        5672
  

  testGeneratedService:
    location: ../playground
    dependencies:
      - runPlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: python ../test_generated_service.py


  testGeneratedContainer:
    location: ../playground
    dependencies:
      - runPlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        echo $(pwd)
        echo $ZARUBA_HOME
        ../zaruba please resetTestRabbitMq flushTestRedis testCassandraExecCql testMySqlExecSql testCassandra.cql="describe keyspaces;" testMySql.sql="show schemas;" -t


  testPlayground:
    location: ../playground
    dependencies:
      - testLogging
      - testGeneratedService
      - testGeneratedContainer
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: ../zaruba please stopContainer
