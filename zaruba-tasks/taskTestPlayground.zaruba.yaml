tasks:

  preparePlayground:
    extend: core.runShellScript
    config:
      start: |
        if [ -d "./playground" ]
        then
          chmod 777 -R ./playground
          rm -Rf ./playground
        fi
        mkdir -p ./playground


  testMakePlayground:
    location: ../playground
    dependencies:
      - build
      - preparePlayground
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please initProject 
        ../zaruba please setProjectValue variableName=defaultImagePrefix variableValue=localhost:9999 
        ../zaruba please addSubrepo subrepoUrl="https://github.com/state-alchemists/fibonacci-clock" subrepoPrefix="fibo" 
        ../zaruba please addSubrepo subrepoUrl="https://github.com/state-alchemists/fibonacci-clock" subrepoPrefix="other-fibo" 
        ../zaruba please initSubrepos 
        ../zaruba please pullSubrepos 
        #
        # docker related
        #
        ../zaruba please makeRabbitmqDockerTask dockerContainerName=testRabbitMq showAdvertisement=no 
        ../zaruba please makeMysqlDockerTask dockerContainerName=testMySql showAdvertisement=no 
        ../zaruba please makeCassandraDockerTask dockerContainerName=testCassandra showAdvertisement=no 
        ../zaruba please makeElasticsearchDockerTask dockerContainerName=testElasticSearch showAdvertisement=no 
        ../zaruba please makeMongoDockerTask dockerContainerName=testMongo showAdvertisement=no 
        ../zaruba please makeRedisDockerTask dockerContainerName=testRedis showAdvertisement=no 
        ../zaruba please makePostgreDockerTask dockerContainerName=testPostgre showAdvertisement=no 
        ../zaruba please makeTrinoDockerTask dockerContainerName=testTrino showAdvertisement=no servicePorts='["8081:8080"]'
        #
        # service related
        #
        ../zaruba please makeStaticServiceTask serviceLocation=fibo serviceEnvs='{"HTTP_PORT": "3001"}' showAdvertisement=no
        ../zaruba please makeNginxServiceTask serviceLocation=testNginx showAdvertisement=no
        ../zaruba please makeAirflowServiceTask serviceLocation=testAirflow redisServiceName=testRedis postgreServiceName=testPostgre showAdvertisement=no 
        ../zaruba please makeMeltanoServiceTask serviceLocation=testMeltano showAdvertisement=no  
        #
        # fastapi related
        #
        ../zaruba please makeFastApiService fastApiServiceName=myService showAdvertisement=no  
        ../zaruba please makeFastApiServiceTask serviceLocation=myService generatorServiceType=fastapi showAdvertisement=no 
        ../zaruba please makeFastApiModule fastApiServiceName=myService fastApiModuleName=myModule showAdvertisement=no 
        ../zaruba please makeFastApiRoute fastApiServiceName=myService fastApiModuleName=myModule fastApiUrl=/hello showAdvertisement=no 
        ../zaruba please makeFastApiEventHandler fastApiServiceName=myService fastApiModuleName=myModule fastApiEventName=myEvent showAdvertisement=no 
        ../zaruba please makeFastApiRpcHandler fastApiServiceName=myService fastApiModuleName=myModule fastApiRpcName=myRpc showAdvertisement=no 
        ../zaruba please makeFastApiCrud fastApiServiceName=myService fastApiModuleName=myModule fastApiCrudEntity=book fastApiCrudFields='["title", "author" , "synopsis"]' showAdvertisement=no 


  testSyncEnv:
    location: ../playground
    dependencies:
      - testMakePlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        touch .env
        ../zaruba please syncEnv 


  testRun:
    location: ../playground
    dependencies:
      - testSyncEnv
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please removeContainer
        ../zaruba please run runTestMeltano -t


  testRunContainer:
    location: ../playground
    dependencies:
      - testRun
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please stopContainer
        ../zaruba please runContainer runTestMeltanoContainer -t


  testBuildImage:
    location: ../playground
    dependencies:
      - testRunContainer
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please buildImage


  testLogging:
    location: ../playground
    dependencies:
      - testBuildImage
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please showLog keyword=myService 


  pullContainerRegistry:
    icon: üê≥
    location: ../
    extend: core.pullDockerImage
    timeout: 1h
    configRef: containerRegistry


  runContainerRegistry:
    icon: üê≥
    location: ../
    extend: core.startDockerContainer
    dependencies:
      - pullContainerRegistry
    configRef: containerRegistry


  testPushImage:
    location: ../playground
    dependencies:
      - runContainerRegistry
      - testBuildImage
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please pushImage
  

  runPlayground:
    location: ../playground
    inputs:
      - runPlaygroundDelay
    dependencies:
      - testPushImage
    extend: core.startService
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please runContainer -e "MY_SERVICE_SQLALCHEMY_DATABASE_URL=sqlite:///database.db"
      afterCheck: |
        sleep 1
        echo "Wait for {{ .GetValue "runPlaygroundDelay" }} s"
        sleep {{ .GetValue "runPlaygroundDelay" }}
      ports: |
        3000
        8080
        15672
        5672

  testRegisterMeltano:
    location: ../playground
    dependencies:
      - runPlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: ../zaruba please registerTestMeltano


  testGeneratedService:
    location: ../playground
    dependencies:
      - runPlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: python ../test_generated_service.py


  testGeneratedContainer:
    location: ../playground
    dependencies:
      - runPlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        echo $(pwd)
        echo $ZARUBA_HOME
        ../zaruba please resetTestRabbitMq flushTestRedis testCassandraExecCql testMySqlExecSql testCassandra.cql="describe keyspaces;" testMySql.sql="show schemas;" -t


  testPlayground:
    location: ../playground
    dependencies:
      - testLogging
      - testGeneratedService
      - testGeneratedContainer
      - testRegisterMeltano
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: ../zaruba please stopContainer
