configs:

  ztplDeploymentName:
    pulumiStack: '{{ if .GetValue "pulumiStack" }}{{ .GetValue "pulumiStack" }}{{ else }}dev{{ end }}'
    pulumiUseLocalBackend: '{{ .GetValue "pulumiUseLocalBackend" }}'
    pulumiSelectStack: |
      {{ if .Util.Bool.IsTrue (.GetConfig "pulumiUseLocalBackend") -}}
      mkdir -p ./pulumiLock
      PULUMI_BACKEND_URL="file://./pulumiLock"
      {{ end -}}
      pulumi stack select "${ZARUBA_CONFIG_PULUMI_STACK}" || pulumi stack init "${ZARUBA_CONFIG_PULUMI_STACK}"

  previewZtplDeploymentName:
    start: |
      {{ .GetConfig "pulumiSelectStack" }}
      pulumi preview

  deployZtplDeploymentName:
    start: |
      {{ .GetConfig "pulumiSelectStack" }}
      pulumi up -y

  destroyZtplDeploymentName: 
    start: |
      {{ .GetConfig "pulumiSelectStack" }}
      pulumi destroy -y

  prepareZtplDeploymentName:
    useImagePrefix: true
    imagePrefix: '{{ .GetValue "defaultImagePrefix" }}'
    namespace: default
    imageName: ztpl-app-image-name
    imageTag: latest
    replicaCount: 1
    start: |
      if [ ! -d "./venv" ]
      then
        python -m venv ./venv
      fi
      source ./venv/bin/activate
      pip install -r requirements.txt
      DEPLOYMENT_CONFIG={}
      IMAGE_NAME="{{ .GetDockerImageName }}"
      IMAGE_TAG="{{ if .GetConfig "imageTag" }}{{ .GetConfig "imageTag" }}{{ else }}latest{{ end }}"
      RAW_ENVS='{{ .Util.Json.FromStringDict .GetEnvs }}'
      RAW_PORTS='{{ .GetConfig "ports" }}'
      . '{{ .GetProjectPath "zaruba-tasks/ztplDeploymentName/bash/util.sh" }}'
      . '{{ .GetProjectPath "zaruba-tasks/ztplDeploymentName/bash/prepareVariables.sh" }}'
      echo "${_YELLOW}ðŸš§ Deployment Config:${_NORMAL} ${DEPLOYMENT_CONFIG}"
      echo "${DEPLOYMENT_CONFIG}" > '{{ .GetProjectPath "ztplDeploymentDirectory/config/config.json" }}'
    ports: |
      ztplAppYamlPorts