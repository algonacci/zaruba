configs:

  ztplDeploymentName:
    pulumiStack: '{{ if .GetValue "pulumiStack" }}{{ .GetValue "pulumiStack" }}{{ else }}dev{{ end }}'
    awsRegion: '{{ if .GetValue "ztplDeploymentNameRegion" }}{{ .GetValue "ztplDeploymentNameRegion" }}{{ else }}us-east-2{{ end }}'
    pulumiSelectStack: |
      PULUMI_STACK='{{ .GetConfig "pulumiStack" }}'
      AWS_REGION='{{ .GetConfig "awsRegion" }}'
      pulumi stack select "${PULUMI_STACK}" || pulumi stack init "${PULUMI_STACK}"
      pulumi config set aws:region "${AWS_REGION}"

  deployZtplDeploymentName:
    start: |
      {{ .GetConfig "pulumiSelectStack" }}
      pulumi up -y
      aws eks --region us-east-2 update-kubeconfig --name $(pulumi stack output cluster-name)

  destroyZtplDeploymentName: 
    start: |
      {{ .GetConfig "pulumiSelectStack" }}
      pulumi destroy -y

  prepareZtplDeploymentName:
    start: |
      if [ ! -d "./venv" ]
      then
        python -m venv ./venv
      fi
      source ./venv/bin/activate
      pip install -r requirements.txt