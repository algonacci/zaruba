tasks:

  testApps:
    dependencies:
      - testRemoveContainers

  testSyncEnv:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testAddComponents
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please syncEnv

  removeContainersBeforeStart:
    location: ../../../../playground
    extend: testAddComponents 
    timeout: 1h
    dependencies:
      - testSyncEnv
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please removeContainers

  testStart:
    location: ../../../../playground
    extend: zrbRunShellScript 
    timeout: 1h
    dependencies:
      - removeContainersBeforeStart
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please start -t

  testStartContainers:
    location: ../../../../playground
    extend: zrbRunShellScript 
    timeout: 1h
    dependencies:
      - testStart
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please startContainers -t
        echo "the containers are still running in the background"
        sleep 5

  testFastApi:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testStartContainers
    configRef: playgroundTest
    config:
      start: |
        python "{{ .GetTaskPath "test_fastapi.py" }}"

  testQueryMysql:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testStartContainers
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please queryProvoMysql sql='SHOW SCHEMAS;'

  testQueryPostgresql:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testStartContainers
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please queryProvoPostgresql sql='SELECT datname FROM pg_database;'

  testQueryCassandra:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testStartContainers
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please queryProvoCassandra sql='DESCRIBE KEYSPACES;'

  testFlushRedis:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testStartContainers
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please flushProvoRedis

  testResetRabbitmq:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testStartContainers
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please resetProvoRabbitmq
  
  testRunMeltano:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testSyncEnv
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please runProvoMeltano

  testBuildMeltanoImage:
    location: ../../../../playground
    extend: zrbRunShellScript 
    timeout: 1h
    dependencies:
      - removeContainersBeforeStart
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please buildProvoMeltanoImage

  testRunMeltanoContainer:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testBuildMeltanoImage
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please runProvoMeltanoContainer

  testPushMeltanoImage:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testBuildMeltanoImage
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please pushProvoMeltanoImage

  testRemoveContainers:
    location: ../../../../playground
    extend: zrbRunShellScript 
    dependencies:
      - testFastApi
      - testQueryMysql
      - testQueryPostgresql
      - testQueryCassandra
      - testFlushRedis
      - testResetRabbitmq
      - testRunMeltano
      - testRunMeltanoContainer
      - testPushMeltanoImage
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please removeContainers

