tasks:

  pushSubrepos:
    icon: ðŸ”¼
    description: |
      Publish subrepositories.
      ARGUMENTS:
        subrepo::<name>::prefix   : Prefix (directory name) of the subrepo
        subrepo::<name>::url      : Remote url of the subrepo
    extend: zrbRunShellScript
    dependencies:
      - initSubrepos
      - updateProjectLinks
    configs:
      start: |
        {{ $names := .GetSubValueKeys "subrepo" -}}
        {{ $this := . -}}
        BRANCH="{{ if .GetValue "defaultBranch" }}{{ .GetValue "defaultBranch" }}{{ else }}main{{ end }}"
        ORIGINS=$("{{ .ZarubaBin }}" str split "$(git remote)")
        {{ range $index, $name := $names -}}
          PREFIX="{{ $this.GetValue "subrepo" $name "prefix" }}"
          URL="{{ $this.GetValue "subrepo" $name "url" }}"
          NAME="{{ $name }}"
          ORIGIN_EXISTS=$("{{ .ZarubaBin }}" list contain "${ORIGINS}" "${NAME}")
          if [ $ORIGIN_EXISTS = 1 ]
          then
            gitSave.sh" "Save works before p
            git subtree push --prefix="${PREFIX}" "${NAME}" "${BRANCH}"
          fi
        {{ end -}}
        echo ðŸŽ‰ðŸŽ‰ðŸŽ‰
        echo "${_BOLD}${_YELLOW}Subrepos pushed${_NORMAL}"

