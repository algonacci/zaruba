version: "3"
services:

  git-server:
    container_name: git-server
    image: jkarlos/git-server-docker
    volumes:
      - "./test-resource/.ssh/id_rsa.pub:/git-server/keys/zaruba.pub"
      - "./test-resource/server-repos:/git-server/repos"
    ports:
      - "2222:22"
  
  zaruba:
    container_name: zaruba
    build: .
    image: stalchmst/zaruba:latest
    environment:
      - "ZARUBA_TEMPLATE_DIR=/tmp/zaruba-template"
      - "ZARUBA_TEST_DIR=/tmp/zaruba-test"
    volumes:
      - "./test-resource/.ssh:/root/.ssh"
      - "./coverage:/zaruba-src/coverage"
      - "./test-resource/server-repos:/zaruba-src/test-resource/server-repos"
    command: >
      bash -c "
      echo 'WAITING GIT SERVER'
      && sleep 5
      && echo 'RUN TEST'
      && ./prepare-test.sh
      && go test ./... --race -coverprofile=./coverage/profile.out -covermode=atomic
      && go tool cover -html=./coverage/profile.out -o ./coverage/coverage.html
      "