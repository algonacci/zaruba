version: "3"
services:

  git-server:
    container_name: ztest-git-server
    image: jkarlos/git-server-docker
    volumes:
      - "./test-resource/.ssh/id_rsa.pub:/git-server/keys/zaruba.pub"
      - "./test-resource/server-repos:/git-server/repos"
    ports:
      - "2222:22"
    command: >
      sh -c "
      echo 'SETUP GIT CONFIG'
      && git config --global user.email 'you@example.com'
      && git config --global user.name 'Your Name'
      && cd repos
      && echo 'CREATE PARENT REPO'
      && rm -Rf parent
      && mkdir -p parent
      && cd parent
      && git init --shared=true
      && echo 'ADD'
      && git add .
      && echo 'COMMIT'
      && git commit -m 'my first commit'
      && cd ..
      && echo 'CLONE'
      && git commit -m 'my first commit'
      && git clone --bare parent parent.git
      && echo 'CREATE CHILD REPO'
      && rm -Rf child
      && mkdir -p child
      && cd child
      && git init --shared=true
      && git add .
      && git commit -m 'my first commit'
      && cd ..
      && git clone --bare child child.git
      && echo 'START DAEMON'
      && cd ..
      && sh ./start.sh
      "
  
  zaruba:
    container_name: ztest-zaruba
    build: .
    image: stalchmst/zaruba:latest
    environment:
      - "ZARUBA_TEMPLATE_DIR=/tmp/zaruba-template"
      - "ZARUBA_TEST_DIR=/tmp/zaruba-test"
    volumes:
      - "./test-resource/.ssh:/root/.ssh"
      - "./coverage:/zaruba-src/coverage"
      - "./test-resource/server-repos:/zaruba-src/test-resource/server-repos"
    command: >
      bash -c "
      echo 'SETUP GIT CONFIG'
      && git config --global user.email 'you@example.com'
      && git config --global user.name 'Your Name'
      && echo 'WAITING GIT SERVER'
      && sleep 5
      && echo 'RUN TEST'
      && cd /zaruba-src
      && ./prepare-test.sh
      && go test ./... --race -coverprofile=./coverage/profile.out -covermode=atomic
      && go tool cover -html=./coverage/profile.out -o ./coverage/coverage.html
      "