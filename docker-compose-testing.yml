version: "3"
services:

  git-server:
    container_name: ztest-git
    image: jkarlos/git-server-docker
    volumes:
      - "./test-resource/.ssh/id_rsa.pub:/git-server/keys/zaruba.pub"
      - "./test-resource/server-repos:/git-server/repos"
    ports:
      - "2222:22"
    command: >
      sh -c "
      pwd
      && echo 'SETUP GIT CONFIG ===================================================='
      && git config --global user.email 'you@example.com'
      && git config --global user.name 'Your Name'
      && echo 'PREPARE REPOS ======================================================='
      && cd repos
      && ./prepare-repos.sh
      && echo 'START DAEMON ========================================================'
      && cd ..
      && sh ./start.sh
      "
  
  zaruba:
    container_name: ztest-zaruba
    build: .
    image: stalchmst/zaruba:latest
    environment:
      - "ZARUBA_TEMPLATE_DIR=/tmp/zaruba-template"
      - "ZARUBA_TEST_DIR=/tmp/zaruba-test"
    volumes:
      - "./test-resource/.ssh:/root/.ssh"
      - "./coverage:/zaruba-src/coverage"
      - "./test-resource/server-repos:/zaruba-src/test-resource/server-repos"
    command: >
      bash -c "
      pwd
      && echo 'SETUP GIT CONFIG ===================================================='
      && git config --global user.email 'you@example.com'
      && git config --global user.name 'Your Name'
      && echo 'WAITING GIT SERVER =================================================='
      && sleep 5
      && echo 'PREPARE TEST ========================================================'
      && cd /zaruba-src
      && (ssh -o StrictHostKeyChecking=no git@ztest-git  || echo "ok")
      && ./prepare-test.sh
      && echo 'RUN TEST ============================================================'
      && go test ./... --race -coverprofile=./coverage/profile.out -covermode=atomic
      && go tool cover -html=./coverage/profile.out -o ./coverage/coverage.html
      "