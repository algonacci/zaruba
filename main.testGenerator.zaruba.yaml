configs:

  playgroundTest:
    beforeStart: |
      set -e
      ZARUBA_HOME="$(realpath "..")"


inputs:

  runPlaygroundDelay:
    default: 10
    description: Delay after run playground


tasks:

  testMakeProject:
    location: ./playground
    dependencies:
      - clearLog
      - build
      - preparePlayground
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please initProject 
        ../zaruba please setProjectValue variableName=defaultImagePrefix variableValue=localhost:9999 
  

  testMakeSubrepo:
    location: ./playground
    dependencies:
      - testMakeProject
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please addSubrepo subrepoUrl="https://github.com/state-alchemists/fibonacci-clock" subrepoPrefix="fibo" 
        ../zaruba please addSubrepo subrepoUrl="https://github.com/state-alchemists/fibonacci-clock" subrepoPrefix="other-fibo" 
        ../zaruba please initSubrepos 
        ../zaruba please pullSubrepos 


  testMakeFastApiService:
    location: ./playground
    extend: core.runShellScript 
    dependencies:
      - testMakeProject
    configRef: playgroundTest
    config:
      start: ../zaruba please makeFastApiService generatorFastApiServiceName=myService showAdvertisement=no setupInitPyUtil=no 


  testMakeServiceTasks:
    location: ./playground
    dependencies:
      - testMakeFastApiService
      - testMakeSubrepo
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please makeStaticServiceTask generatorServiceLocation=fibo 
        ../zaruba please makeFastApiServiceTask generatorServiceLocation=myService generatorServiceType=fastapi showAdvertisement=no setupInitPyUtil=no 


  testMakeDockerTasks:
    location: ./playground
    dependencies:
      - testMakeServiceTasks
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please makeRabbitmqDockerTask generatorDockerContainerName=testRabbitMq showAdvertisement=no setupInitPyUtil=no 
        ../zaruba please makeMysqlDockerTask generatorDockerContainerName=testMySql showAdvertisement=no setupInitPyUtil=no 
        ../zaruba please makeCassandraDockerTask generatorDockerContainerName=testCassandra showAdvertisement=no setupInitPyUtil=no 
        ../zaruba please makeElasticsearchDockerTask generatorDockerContainerName=testElasticSearch showAdvertisement=no setupInitPyUtil=no 
        ../zaruba please makeMongoDockerTask generatorDockerContainerName=testMongo showAdvertisement=no setupInitPyUtil=no 
        ../zaruba please makeRedisDockerTask generatorDockerContainerName=testRedis showAdvertisement=no setupInitPyUtil=no 
        

  testMakeFastApiModule:
    location: ./playground
    dependencies:
      - testMakeFastApiService
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: ../zaruba please makeFastApiModule generatorFastApiServiceName=myService generatorFastApiModuleName=myModule showAdvertisement=no setupInitPyUtil=no 


  testMakeFastApiRoute:
    location: ./playground
    dependencies:
      - testMakeFastApiModule
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: ../zaruba please makeFastApiRoute generatorFastApiServiceName=myService generatorFastApiModuleName=myModule generatorFastApiUrl=/hello showAdvertisement=no setupInitPyUtil=no 


  testMakeFastApiEventHandler:
    location: ./playground
    dependencies:
      - testMakeFastApiRoute
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: ../zaruba please makeFastApiEventHandler generatorFastApiServiceName=myService generatorFastApiModuleName=myModule generatorFastApiEventName=myEvent showAdvertisement=no setupInitPyUtil=no 


  testMakeFastApiRpcHandler:
    location: ./playground
    dependencies:
      - testMakeFastApiEventHandler
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: ../zaruba please makeFastApiRpcHandler generatorFastApiServiceName=myService generatorFastApiModuleName=myModule generatorFastApiRpcName=myRpc showAdvertisement=no setupInitPyUtil=no 


  testMakeFastApiCrud:
    location: ./playground
    dependencies:
      - testMakeFastApiRpcHandler
    extend: core.runShellScript 
    configRef: playgroundTest
    config:
      start: ../zaruba please makeFastApiCrud generatorFastApiServiceName=myService generatorFastApiModuleName=myModule generatorFastApiCrudEntity=book generatorFastApiCrudFields='["title", "author" , "synopsis"]' showAdvertisement=no setupInitPyUtil=no 
  

  testSyncEnv:
    location: ./playground
    dependencies:
      - testMakeFastApiCrud
      - testMakeDockerTasks
      - testMakeServiceTasks
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: ../zaruba please syncEnv 


  testRun:
    location: ./playground
    dependencies:
      - testSyncEnv
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please stopContainer
        ../zaruba please run  -t


  testRunContainer:
    location: ./playground
    dependencies:
      - testRun
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please removeContainer 
        ../zaruba please runContainer  -t
        ../zaruba please removeContainer 


  testBuildImage:
    location: ./playground
    dependencies:
      - testRunContainer
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        git add . -A && git commit -m 'first commit'
        git tag -a v0.0.0 -m 'version 0.0.0'
        ../zaruba please buildImage


  testGenerator:
    location: ./playground
    dependencies:
      - testMakeProject
      - testMakeSubrepo
      - testMakeDockerTasks
      - testMakeServiceTasks
      - testMakeFastApiService
      - testMakeFastApiModule
      - testMakeFastApiRoute
      - testMakeFastApiEventHandler
      - testMakeFastApiRpcHandler
      - testMakeFastApiCrud
      - testSyncEnv
      - testRun
      - testRunContainer
      - testBuildImage


  testLogging:
    location: ./playground
    dependencies:
      - testGenerator
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please showLog logKeyword=myService 
        ../zaruba please clearLog 
  

  runContainerRegistry:
    icon: üê≥
    location: ./
    extend: core.startDockerContainer
    dependencies:
      - clearLog
    config:
      useImagePrefix: false
      imageName: registry
      imageTag: 2
      containerName: containerRegistry
      localhost: host.docker.internal
      ports: |
        9999: 5000


  testPushImage:
    location: ./playground
    dependencies:
      - clearLog
      - runContainerRegistry
      - testGenerator
    extend: core.runShellScript
    timeout: 1h
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please pushImage
  

  runPlayground:
    location: ./playground
    inputs:
      - runPlaygroundDelay
    dependencies:
      - clearLog
      - build
      - testGenerator
    extend: core.startService
    configRef: playgroundTest
    config:
      start: |
        ../zaruba please removeContainer 
        ../zaruba please runContainer  -e "MY_SERVICE_SQLALCHEMY_DATABASE_URL=sqlite:///database.db"
      afterCheck: |
        sleep 1
        echo "Wait for {{ .GetValue "runPlaygroundDelay" }} s"
        sleep {{ .GetValue "runPlaygroundDelay" }}
      ports: |
        3000
        8080
        15672
        5672
  

  testGeneratedService:
    location: ./playground
    dependencies:
      - clearLog
      - runPlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: python ../test_generated_service.py


  testGeneratedContainer:
    location: ./playground
    dependencies:
      - clearLog
      - runPlayground
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: ../zaruba please resetTestRabbitMq flushTestRedis testCassandraExecCql testMySqlExecSql testCassandra.cql="describe keyspaces;" testMySql.sql="show schemas;" -t


  testPlayground:
    location: ./playground
    dependencies:
      - testGeneratedService
      - testGeneratedContainer
    extend: core.runShellScript
    configRef: playgroundTest
    config:
      start: ../zaruba please stopContainer
